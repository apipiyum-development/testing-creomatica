# Финальный Dockerfile для LLM Council Frontend
# Только nginx для раздачи статических файлов

# Stage 1: Сборка фронтенда
FROM node:18-alpine AS frontend-builder

WORKDIR /app

# Копируем файлы зависимостей
COPY package*.json ./
RUN npm install

# Копируем остальные исходные файлы
COPY . .

# Собираем фронтенд
RUN npm run build

# Stage 2: Установка бэкенда (для доступа к собранному фронтенду)
FROM python:3.11-alpine AS backend

WORKDIR /app

# Установка системных зависимостей
RUN apk add --no-cache gcc musl-dev

# Установка зависимостей Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Копируем исходный код бэкенда
COPY . .

# Копируем собранный фронтенд из предыдущего этапа
COPY --from=frontend-builder /app/dist /app/dist

# Stage 3: Финальный образ только с nginx
FROM nginx:alpine

# Копируем собранную frontend-сборку в корневую директорию nginx
COPY --from=frontend-builder /app/dist /usr/share/nginx/html

# Копируем конфигурацию nginx
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 300

# Запуск nginx
CMD ["nginx", "-g", "daemon off;"]