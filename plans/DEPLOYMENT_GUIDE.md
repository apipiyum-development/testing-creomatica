# Руководство по развертыванию LLM Council

## Обзор

Этот документ описывает процесс развертывания приложения LLM Council с использованием Docker и Docker Compose. Приложение состоит из фронтенд-части (React/Vite) и бэкенд-части (FastAPI), объединенных в одном контейнере с использованием nginx и supervisor.

## Архитектура

- **Фронтенд**: React/Vite приложение, обслуживаемое через nginx на порту 3000
- **Бэкенд**: FastAPI приложение, работающее на порту 8000
- **Прокси**: nginx для маршрутизации запросов между фронтендом и бэкендом
- **Управление процессами**: supervisor для одновременного запуска nginx и uvicorn
- **Сетевая инфигурация**: Traefik для маршрутизации и SSL-терминации

## Требования

- Docker (версия 20.10 или выше)
- Docker Compose (версия 2.0 или выше)
- Доступ к домену `llm.clusterdev.ru`
- API ключ для PolzaAI

## Подготовка

### 1. Клонирование репозитория

```bash
git clone <ваш_репозиторий>
cd <папка_с_проектом>
```

### 2. Настройка переменных окружения

Создайте или обновите файлы `.env` и `services/.env`:

```
POLZAAI_API_KEY=ваш_api_ключ_здесь
```

### 3. Проверка конфигурационных файлов

Убедитесь, что в проекте присутствуют следующие файлы:

- `docker/Dockerfile` - определяет сборку образа
- `docker/nginx.conf` - конфигурация nginx
- `docker-compose.yml` - оркестрация сервисов
- `main.py` - основной бэкенд-сервер
- `package.json` - зависимости фронтенда

## Сборка и запуск

### 1. Сборка образа

```bash
docker-compose build
```

### 2. Запуск приложения

```bash
docker-compose up -d
```

### 3. Проверка состояния

```bash
docker-compose ps
```

## Проверка работоспособности

### 1. Проверка доступности веб-интерфейса

Откройте в браузере: `https://llm.clusterdev.ru`

### 2. Проверка API

```bash
curl -X GET https://llm.clusterdev.ru/
```

Должен вернуться JSON: `{"message": "LLM Council API is running!"}`

### 3. Проверка API эндпоинта совета

```bash
curl -X POST https://llm.clusterdev.ru/council \
  -H "Content-Type: application/json" \
  -d '{"query": "Тестовый запрос"}'
```

## Отладка

### Проверка логов контейнера

```bash
docker-compose logs llm-council
```

### Проверка логов nginx

```bash
docker-compose exec llm-council cat /var/log/nginx/access.log
docker-compose exec llm-council cat /var/log/nginx/error.log
```

### Проверка логов приложения

```bash
docker-compose exec llm-council cat /var/log/uvicorn.log
```

## Возможные проблемы и решения

### 1. Ошибка перезапуска контейнера

Если контейнер постоянно перезапускается:

- Проверьте логи: `docker-compose logs llm-council`
- Убедитесь, что API ключ в `.env` действителен
- Проверьте права доступа к файлам

### 2. Ошибка 404 для API эндпоинтов

- Убедитесь, что пути в nginx.conf корректны
- Проверьте, что бэкенд-сервис запущен на порту 8000

### 3. Проблемы с SSL/HTTPS

- Убедитесь, что Traefik настроен корректно
- Проверьте, что домен `llm.clusterdev.ru` указывает на правильный IP-адрес

### 4. Проблемы с SSE (Server-Sent Events)

- Убедитесь, что настройки прокси в nginx.conf корректны для SSE
- Проверьте таймауты и настройки буферизации

## Конфигурационные файлы

### docker/Dockerfile

Создает многоступенчатую сборку с фронтендом (React/Vite) и бэкендом (FastAPI), объединяя их в одном контейнере с nginx и supervisor.

### docker/nginx.conf

Конфигурация nginx для маршрутизации запросов:
- Статические файлы фронтенда на `/`
- API запросы к бэкенду на `/council`

### docker-compose.yml

Определяет сервис с настройками:
- Права безопасности
- Ограничения ресурсов
- Маршруты Traefik
- Переменные окружения

## Безопасность

- Используется `no-new-privileges:true` для предотвращения повышения привилегий
- Ограничения ресурсов для предотвращения DoS-атак
- Трафик между сервисами изолирован в сети `n8n_default`

## Мониторинг

### Логи

- Приложение: `/var/log/uvicorn.log` в контейнере
- Nginx: стандартные логи nginx
- Docker: через `docker-compose logs`

### Метрики

Приложение предоставляет эндпоинт `/` для проверки состояния.

## Обновление

### 1. Обновление кода

```bash
git pull origin main
```

### 2. Пересборка образа

```bash
docker-compose build --no-cache
```

### 3. Перезапуск сервиса

```bash
docker-compose up -d
```

## Удаление

### Остановка сервиса

```bash
docker-compose down
```

### Удаление контейнеров, сетей и томов

```bash
docker-compose down -v
```

## Заключение

Приложение LLM Council теперь успешно развернуто и готово к использованию. Архитектура обеспечивает стабильную работу фронтенд- и бэкенд-компонентов в одном контейнере с правильной маршрутизацией запросов и обработкой SSE.