# План развертывания проекта LLM Council

## Общая архитектура

LLM Council - это веб-приложение с архитектурой "один проект", включающее:
- FastAPI бэкенд (порт 8000)
- React/Vite фронтенд (порт 3000)
- Общие сервисы и конфигурации

## Стратегия развертывания

### 1. Многоступенчатая сборка Docker

Используется многоступенчатая сборка для оптимизации размера конечного образа:
1. **Stage 1**: Сборка фронтенда с использованием Node.js
2. **Stage 2**: Установка бэкенда с Python зависимостями
3. **Stage 3**: Установка Nginx и объединение всех компонентов

### 2. Внутренняя архитектура контейнера

- Nginx работает на порту 3000 и обслуживает статические файлы фронтенда
- FastAPI работает на порту 8000 и обрабатывает API запросы
- Nginx проксирует API запросы с порта 3000 на порт 8000

### 3. Интеграция с traefik

Используются следующие настройки маршрутизации:
- `llm.clusterdev.ru` → фронтенд (порт 3000)
- `llm.clusterdev.ru/council*` → бэкенд (порт 8000)

### 4. Поддержка SSE

Для корректной работы Server-Sent Events:
- В nginx.conf отключена буферизация для `/council/stream`
- В traefik настроен `flushinterval=100ms`
- Установлены соответствующие таймауты

## Файлы конфигурации

### docker/Dockerfile
Многоступенчатый Dockerfile с оптимизацией размера образа

### docker/nginx.conf
Конфигурация Nginx с поддержкой SSE и проксированием API запросов

### docker/traefik-sse-config.md
Документация по настройке SSE через traefik

### docker-compose.yml
Основной файл оркестрации с настройками безопасности, traefik и переменными окружения

## Переменные окружения

- `POLZAAI_API_KEY` - API ключ для PolzaAI, берется из services/.env

## Безопасность

- Ограничения ресурсов (память, CPU)
- Безопасные опции Docker (no-new-privileges)
- Внешняя сеть n8n_default для изоляции

## Запуск

Для запуска проекта выполните:
```bash
docker-compose up -d
```

## Проверка работоспособности

1. Убедитесь, что оба сервиса запущены:
   - Фронтенд: https://llm.clusterdev.ru
   - Бэкенд: https://llm.clusterdev.ru/council (должен вернуть ошибку 405, т.к. нужен POST запрос)

2. Протестируйте соединение:
   - Введите тестовый запрос на фронтенде
   - Наблюдайте за процессом 3-ступенчатого обсуждения
   - Проверьте, что SSE работает корректно (ответы поступают постепенно)

## Мониторинг и логирование

- Логи контейнера: `docker logs llm-council`
- Мониторинг ресурсов: `docker stats llm-council`

## Обновление

Для обновления приложения:
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d